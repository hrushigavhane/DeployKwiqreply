 {% load static %}

<!DOCTYPE html>
 <html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CONVERSE</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.ico' %}"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="{% static 'css/icheck-bootstrap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'css/adminlte.min.css' %}">

  <link rel="stylesheet" href="{% static 'css/Chart.min.css' %}">

  <link rel="stylesheet" href="{% static 'css/Chart.css' %}">

  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <!-- jQuery -->
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <!-- Bootstrap 4 -->
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <!-- AdminLTE App -->
  <script src="{% static 'js/adminlte.min.js' %}"></script>
  <!-- DEMO -->
  <script src="{% static 'js/demo.js' %}"></script>

  <script src="{% static 'js/Chart.js' %}"></script>
  <script src="{% static 'js/Chart.min.js' %}"></script>

</head>



<body class="hold-transition sidebar-mini">

  <div class="wrapper ">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link sidebar-mini sidebar-collapse" data-toggle="collapse" data-widget="pushmenu" href="#"><i class="fa fa-bars"></i></a>
        </li>
        {% comment %} <li class="nav-item d-none d-sm-inline-block">
          <a href="step1" class="nav-link">Home</a>
        </li> {% endcomment %}
      </ul>


      <!-- SEARCH FORM -->
      <!--<form class="form-inline ml-3">
        <div class="input-group input-group-sm">
          <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
          <div class="input-group-append">
            <button class="btn btn-navbar" type="submit">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
      </form>-->


      <ul class="navbar-nav ml-auto">
            <!-- Messages Dropdown Menu -->
            <li class="nav-item dropdown">
                {% for i in obj %}
                    <a href="profile" class="nav-link"><i class="fa fa-user-o" aria-hidden="true" style="color:black"></i> {{ i.first_name }} {{ i.last_name }}</a>
                {% endfor %}
            </li>
          </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
    
      <a href="step1" class="brand-link" style="text-align: center;">
        <span class="brand-text">
              <img src="{% static 'img/icon/ktpllogo.svg' %}" class="brand-image center" style=" width:100%; height:100%;"><br>
        </span>
      </a>
    
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="{% static 'img/icon/whatsapp .png' %}" alt="User Image" >
          </div>
          <div class="info">
            <h5 class="d-block" style="color:white">WhatsApp Beta</h5>
          </div>
        </div>
    
        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
    
            {% comment %} <li class="nav-item has-treeview" >
           <a href="dashboard" class="nav-link " >
               <i class="nav-icon fa fa-dashcube" ></i>
                  <b><p>Dashboard</p></b>
              </a>
           </li> {% endcomment %}
    
            <li class="nav-item has-treeview" >
              <a href="step1" class="nav-link" >
                <i class="nav-icon fa fa-graduation-cap" ></i>
                <p>Learn</p>
              </a>
            </li>
              <li class="nav-item has-treeview">
              <a href="businessprofile" class="nav-link">
                <i class="nav-icon fa fa-try"></i>
                  <p>Apply</p>
              </a>
            </li>
    
    {% comment %} 
            <li class="nav-item has-treeview" >
              <a href="sandbox" class="nav-link" >
                <i class="nav-icon fa fa-shield" ></i>
                  <p>Sandbox</p>
              </a>
            </li> {% endcomment %}
    
            <li class="nav-item has-treeview">
              <a href="senders" class="nav-link">
                <i class="nav-icon fa fa-users"></i>
                  <p>Whatsapp Numbers</p>
              </a>
            </li>
    
            <li class="nav-item has-treeview">
              <a href="#" class="nav-link active">
                <i class="nav-icon fa fa-commenting "></i>
                <p>
                  Chat Window
                  <i class="fa fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <!-- <li class="nav-item">
                  <a href="chat_statistics" class="nav-link">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Chat Dashboard</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="audience" class="nav-link">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Audience</p>
                  </a>
                </li> -->
                <li class="nav-item">
                  <a href="converse" class="nav-link active">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Converse</p>
                  </a>
                </li>
                <!-- <li class="nav-item">
                  <a href="announce" class="nav-link">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Announce</p>
                  </a>
                </li> -->
              </ul>
            </li>
    
            <!-- <li class="nav-item has-treeview">
              <a href="logs" class="nav-link">
                <i class="nav-icon fa fa-history"></i>
                  <p>Logs</p>
              </a>
            </li>
    
            <li class="nav-item has-treeview">
              <a href="#" class="nav-link">
                <i class="nav-icon fa fa-edit"></i>
                <p>
                  Insights
                  <i class="fa fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="insight1" class="nav-link">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Message Queue</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="insight2" class="nav-link">
                    <i class="fa fa-circle nav-icon"></i>
                    <p>Message Feedback</p>
                  </a>
                </li>
              </ul>
            </li> -->
    
            <!-- <li class="nav-item has-treeview">
              <a href="usage" class="nav-link">
                <i class="nav-icon fa fa-hourglass-start"></i>
                  <p>Usage</p>
              </a>
            </li> -->
    
            <li class="nav-item has-treeview">
              <a href="profile" class="nav-link">
                <i class="nav-icon fa fa-user"></i>
                  <p>Profile</p>
              </a>
            </li>
    
    
            {% comment %} <li class="nav-item has-treeview">
              <a href="general_settings" class="nav-link">
                <i class="nav-icon fa fa-cogs"></i>
                <p>
                  Settings
                </p>
              </a>
            </li> {% endcomment %}
    
    
            <li class="nav-item has-treeview">
              <a href="logout" class="nav-link">
                <i class="nav-icon fa fa-sign-out"></i>
                  <p>Logout</p>
              </a>
            </li>
          </ul>
        </nav>
        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->
    </aside>


    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" >
      <!-- Content Header (Page header) -->
      <!-- Main content -->
      <section class="content ">
        <div class="container" style="padding-top:30px;" >
         <div class="card  card-outline">
          <div class="card-body ">

            <div class="row">

              <div class="col-lg-4" style="background-color:#dde3e9">
                <div class="position-relative p-3">
                  <h3 style="float:left">Chats</h3>
                  <!--<button class="btn btn-success" style="float:right;">Online</button>-->
                  <br>
                </div>

                <input type="text" name="search" id="search" placeholder="Search" maxlength="12" onkeyup="search();" style="width:97%;padding:5px">
                <i id="search-icon" class="fa fa-search" style="margin-left:-25px;"></i>
                <div class="position-relative p-3" style="text-align:center">
                  {% comment %} <button type="button" class=" btn btn-success collapsible" style="color:#007bff; background-color:#dde3e9; border:none"><i class="fa fa-check" aria-hidden="true"></i> Active (X)
                  <i class="fa fa-chevron-circle-down" aria-hidden="true" style="color:black; padding-left:10px;"></i></button> {% endcomment %}

                    <div class="content whatsapp_number" style="display:block;  max-height:500px; overflow:scroll; overflow:auto;">
                      {% include "get_count.html" %}                      

                    </div>
                  </div>
                </div>
              <div class="col-lg-8" style="background-color:white;">
                <div class=" cardutline direct-chat direct-chat-primary">
                  <div class="card-header" style="background-color:#001f3f">
                    <i class="fa fa-whatsapp" aria-hidden="true" style="color:#28a745;float:left;padding-top: 2px;"></i> <h3 class="card-title" id="wa_number1" style="color:white; padding-left: 6px; padding-right: 2px;"></h3><h3 class="card-title" id="wa_name1" style="color:white; padding-left: 2px; padding-right: 2px;"></h3>
                    <!--<div class="card-tools">
                      <button type="button" class="btn btn-tool"><i class="fa fa-ban" aria-hidden="true"></i></button>
                      <button type="button" class="btn btn-tool"><i class="fa fa-bookmark" aria-hidden="true"></i></button>
                      <button type="button" class="btn btn-tool"><i class="fa fa-envelope" aria-hidden="true"></i></button>
                      <button type="button" class="btn btn-tool"><i class="fa fa-ticket" aria-hidden="true"></i></button>
                      <button type="button" class="btn btn-tool"><i class="fa fa-user" aria-hidden="true"></i></button>
                      <button type="button" class="btn btn-tool"><i class="fa fa-info-circle" aria-hidden="true"></i></button>
                    </div>-->
                  </div>
              <div class="card-body"  style="height:520px ">
                <div class="direct-chat-messages" id="chat-box" style=" min-height: 100%; height:auto; overflow:auto; display: flex; flex-direction: column-reverse; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');">
                
                </div>
              </div>
              <div class="card-footer" style="background-color:white;display:none;">
                <form >
                  {% csrf_token %}
                  <div class="input-group">
                    <span class="input-group-prepend col-sm-12" style="float:left; margin-left:-30px; max-width:20px;" >
                        <button type="button" class="btn btn-default" title="Add Image/Video/File" data-toggle="modal" data-target="#richMix" ><i class="fa fa-paperclip" alt="aria-hidden=" true ></i></button></input>
                        <!--<button type="button" class="btn btn-default" title="Add Contact" data-toggle="modal" data-target="#richContact" ><i class="fa fa-address-book" alt="aria-hidden="true"></i></button></input>-->
                        {% comment %} <button type="button" class="btn btn-default" title="Add Location" data-toggle="modal" data-target="#richLoc" ><i class="fa fa-map-marker" alt="aria-hidden="true"></i></button></input>
                        <button type="button" class="btn btn-default" title="Add Audio" data-toggle="modal" data-target="#richAudio" ><i class="fa fa-music" alt="aria-hidden="true"></i></button></input> {% endcomment %}
                    </span>
                    <textarea name="message" id="message" placeholder="Type Message ..." class="form-control" rows="1" style="float:left; margin-left:20px;"></textarea>
                    <span class="input-group-append">
                      <button  type="button" class="btn btn-primary" onclick="send_message()"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                    </span>
                  </div>
                </form>
              </div>
            </div>
            </div>
          </div>

        </div>
      </div>
    </div>
        <!--- Modal Popup for rich message---!>
        <div id="richMix" class="modal fade" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content" >
              <div class="modal-header">
                <h4 class="modal-title">Media Uploader</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <div id="rMessage">
                  <h6>Upload from URL</h6>
                  <form name="addMessageForm" id="addMessageForm" enctype="multipart/form-data" novalidate>
                      <input type="text" name="load" id="load" class="txtinput" value=""/>
                      <button type="button" class="mgb" onclick="loadFile()">Load</button>
                      <div class="line-div">
                          <hr class="line-break">
                          <div class="l-b-txt">or</div>
                      </div>

                      {% csrf_token %}
                    <div class="disp-img-wrp"><div id="img-wrp" /></div><span class="file_name"></span></div>
                      <input class="hide" type="file" required="required" name="browseFile" id="browseFile" accept=".png,.jpeg,.jpg,.mp4,.avi,.pdf,.docx,.txt">

                      <div class="mgc-fl">
                          <button class="mgb" type="button" data-action="browse" onclick="document.getElementById('browseFile').click();">Browse</button>
                      </div>
                      <div class="img-info">
                        <div class="i-info-format" title="" id="ui-id-14"><span class="i-i-span">ACCEPTED FORMATS: </span>.png, .jpeg, .jpg, .mp4, .avi, .pdf, .txt</div>
                        <div class="i-info-size  " title="25MB" id="ui-id-17"><span class="i-i-span">MAX FILE SIZE: </span>25MB</div>
                      </div>
                      <div>
                        Add Caption:
                        <input type="text" name="caption" id="caption" class="txtinput" value=""/>

                      </div>
                    <div class="modal-footer">
                      <button type="submit" class="mgb"  id="addMessage" disabled>Send File</button>
                      <button type="button" class="mgb" data-dismiss="modal" style="background-color:red;">Close</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- popup closed -->
            <!-- /.card -->
        <!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <div class="main-footer">
      <strong>Copyright &copy; 2021 <a href="#">Khairnar Technologies Private Limited</a>.</strong>
      All rights reserved.
    </div>


    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  
  <script>
  $(document).ready(function () {
      
      get_unread();
      get_count();  
      
    });


  var coll = document.getElementsByClassName("collapsible");
  var i;

  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }



  var timer=false;
    function send_message(){
      var message = $("#message").val();
      var to = $("#wa_number1").html();
      var name=$("#wa_name1").html()

      console.log(to,message,name)

      $.ajax({
        url: '/ajax/send_message/',
        data: {
          'message': message,
          'to':to.trim(),
          'name':name.trim()
        },
        dataType: 'json',
        success: function (data) {
           $("#message").val("");
        }
      });

    }
    function get_unread(){
      var to = $("#wa_number1").html();
      $.ajax({
        url: '/ajax/get_unread/',
        data: {
          'wa_number': to.trim()
        },

        success: function (data1) {
        $("#chat-box").append(data1);
        if(data1.trim()!==""){
            $.ajax({
              url: '/ajax/update_status/',
              data: {
                'wa_number': to.trim()
              }

            });
          }
        }
      });

    }

    function get_chat(wa_number,wa_name){

      if(timer==true){
        clearInterval(get_msg);
      }
      timer=false;
      $.ajax({
        url: '/ajax/get_chat/',
        data: {
          'wa_number': wa_number
        },

        success: function (data) {

            $(".whatsapp_number a").removeClass("p_active");
            $("#p_"+wa_number).addClass("p_active");
            $("#chat-box").empty();
            $("#chat-box").html(data);
            $(".card-footer").css("display","block");

            document.getElementById("wa_number1").innerHTML =" "+wa_number+" ";
            document.getElementById("wa_name1").innerHTML =" "+wa_name+" ";

            $(function () {
                timer=true;
                get_msg=setInterval('get_unread()', 3000);
            });


        }
      });

    }
   

$(function(){
      get_cnt=setInterval('get_count()', 5000);
   });

    function get_count(){
  $(".whatsapp_number").load("/ajax/get_count/");
}


function loadFile(){

  var fileUrl=$("#load").val();
  var fileTypes = ['jpg', 'jpeg', 'png', 'mp4', 'avi', 'pdf', 'docx', 'txt'];
  var imageTypes = ['jpg', 'jpeg', 'png'];
  var ext=fileUrl.split(/[#?]/)[0].split('.').pop().trim();
  isSuccess=fileTypes.indexOf(ext) > -1;
  isImage= imageTypes.indexOf(ext) > -1;
  $('.file_name').text("");
  if(isSuccess){
      if(isImage){

        if($(".img-wrp").parents("#img-wrp").length == 1){
          $('.img-wrp').attr('src', fileUrl).height(200);
        }
        else{
          $('#img-wrp').prepend($('<img>',{class:'img-wrp',src:''}))
          $('.img-wrp').attr('src', fileUrl).height(200);
        }
        document.getElementById("addMessage").disabled = false;
      }else{

        if(ext == "mp4" || ext=="avi"){
           if($(".img-wrp").parents("#img-wrp").length == 1){
            $('.img-wrp').attr('src', '/static/img/video_file.png').height(200);
          }
          else{
            $('#img-wrp').prepend($('<img>',{class:'img-wrp',src:''}))
            $('.img-wrp').attr('src', '/static/img/video_file.png').height(200);
          }

        }else{
            if($(".img-wrp").parents("#img-wrp").length == 1){
              $('.img-wrp').attr('src', '/static/img/file-empty.png').height(200);
            }
            else{
              $('#img-wrp').prepend($('<img>',{class:'img-wrp',src:''}))
              $('.img-wrp').attr('src', '/static/img/file-empty.png').height(200);
            }

        }
         $('.file_name').text(fileUrl);
         document.getElementById("addMessage").disabled = false;
      }
  }else{

  }

}

$("#browseFile").change(function(){

          var fileTypes = ['jpg', 'jpeg', 'png', 'mp4', 'avi', 'pdf', 'docx', 'txt'];
          var imageTypes = ['jpg', 'jpeg', 'png'];
          $('#load').val("");
          if (this.files && this.files[0]) {

            var extension = this.files[0].name.split('.').pop().toLowerCase(),  //file extension from input file
            isSuccess = fileTypes.indexOf(extension) > -1;  //is extension in acceptable types
             isImage= imageTypes.indexOf(extension) > -1;
             var name=this.files[0].name;
             if (isSuccess) { //yes
                  var reader = new FileReader();
                  reader.onload = function (e) {
                    if(isImage){
                          if($(".img-wrp").parents("#img-wrp").length == 1){
                            $('.img-wrp').attr('src', e.target.result).width(200).height(200);
                          }
                          else{
                            $('#img-wrp').prepend($('<img>',{class:'img-wrp',src:''}))
                            $('.img-wrp').attr('src', e.target.result).width(200).height(200);
                          }

                       document.getElementById("addMessage").disabled = false;
                    }else{
                          if($(".img-wrp").parents("#img-wrp").length == 1){
                            $('.img-wrp').attr('src', '/static/img/file-empty.png').width(200).height(200);
                          }
                          else{
                            $('#img-wrp').prepend($('<img>',{class:'img-wrp',src:''}))
                            $('.img-wrp').attr('src', '/static/img/file-empty.png').width(200).height(200);
                          }

                       $('.file_name').text(name);
                       document.getElementById("addMessage").disabled = false;
                    }
                  }

                  reader.readAsDataURL(this.files[0]);
              }
              else {
                  alert("Selected file type is not supported");
              }
        }
});



$( "#mText" ).click(function() {
  $("#rMessage").append("<div class='divText' style='font-size:1.2rem;'><div class='text-count'></div><i class='fa fa-times-circle' onclick='deleteDiv(this);' title='delete' aria-hidden='true' style='float: left;cursor: pointer;'></i><textarea class='addText' onkeypress='countChar(this,event)' style='font-size:.8rem;width:200px;height:70px;'></textarea></div>");
});


 function countChar(val,e) {
        var len = val.value.length;
        if (len <= 640) {
          $('.text-count').text(640 - len);
        } else {
          e.preventDefault();
          $('.text-count').text(640-len);
        }
      }
      function deleteDiv(element){
        $(element).closest('div').remove();
      }

$("#addMessageForm").on('submit', function(e){
		e.preventDefault();
		var check = $('.img-wrp').attr('src');
		var to1 = $("#wa_number1").html();
        var name1=$("#wa_name1").html()
        var form = document.getElementById("addMessageForm"),
        myData = new FormData(form);
		myData.append('to', to1.trim());
		myData.append('name', name1.trim());

        $.ajax({
            type:'POST',
            url:'ajax/send_file/',
            data: myData,
            dataType: 'json',
            contentType: false,
            cache: false,
            processData:false,
            beforeSend: function(){
                $('#addMessage').attr("disabled","disabled");
                $('#addMessageForm').css("opacity",".5");
            },
            success:function(result){
                 if(result.message=="success"){
                   alert("The Message has been sent successfully");
                   $('#addMessage').attr("disabled",false);
                   $('#addMessageForm').css("opacity","1");
                   $("#addMessageForm").trigger("reset");
                   $("#img-wrp img:last-child").remove()
                   $('.file_name').text("");
                 }else{
                   alert(result);
                }
            }
        });

  	});

$(window).on('load', function(){
  $('.modal.fade').appendTo('body');
})

function search(){
  clearInterval(get_cnt);
  var term=$("#search").val();
$(".whatsapp_number").empty();
if(term==""){
  get_cnt=setInterval('get_count()', 5000);
}else{
   $.ajax({
        url: '/ajax/search/',
        data: {
          'search': term.trim()
        },
        success: function (data1) {
           $(".whatsapp_number").html(data1);
        }
      });
      }
}

  </script>

  </body>
</html>
